import streamlit as st
import fitz  # PyMuPDF
from io import BytesIO
from reportlab.pdfgen import canvas
from reportlab.graphics.barcode import code128
from reportlab.lib.pagesizes import letter

# -----------------------------
# FULL LIST OF VALID ITEM NUMBERS
# -----------------------------
KNOWN_ITEMS = {
    "101500002", "101507674", "101700361", "101700365", "101700608", "101700666", "101700694", "101701333",
    "101701444", "101701493", "101702034", "102042981", "150102511", "190102951", "190115893", "190140078",
    "190144366", "190144369", "190184793", "190202589", "190215954", "190407023", "190501844", "190501845",
    "190501846", "193100135", "193100201", "194200613", "194211042", "194213173", "194213174", "194214230",
    "194218224", "194218963", "194219251", "194220728", "194222476", "194225053", "194227489", "200405060",
    "200435192", "202301170", "202303450", "300221259", "300221592", "300222409", "300223835", "300227081",
    "300227160", "300227164", "300227166", "300227240", "300227241", "300227245", "300227285", "300227790",
    "300227796", "300227878", "300227879", "300227885", "300227886", "300227887", "300227955", "300227967",
    "300227971", "300228004", "300228005", "300228010", "300228078", "300228225", "300228226", "300228315",
    "300228317", "300228506", "300228781", "300228782", "300228783", "300229172", "300229308", "300511252",
    "300512261", "300512811", "300512953", "300513405", "300513406", "300513523", "300609061", "300609640",
    "300609994", "300609997", "300611564", "300611846", "300611891", "300611898", "300612505", "300612714",
    "300612798", "300613382", "300613445", "300613558", "300613623", "300613630", "300613800", "300613860",
    "300614444", "300614669", "300614670", "300614678", "300614772", "300614935", "300615015", "300615087",
    "300615088", "300615179", "300615278", "300615453", "300615455", "300904025", "301205314", "301205339",
    "301205347", "301310280", "301501344", "301501434", "301501460", "301501525", "301501535", "301501537",
    "301501538", "301501539", "301501577", "301501591", "301501647", "301501657", "301501658", "301501711",
    "301501723", "301501726", "301501729", "301501730", "301501737", "301501738", "301501743", "301501744",
    "301501846", "301501848", "301501851", "301501852", "301501853", "301501906", "301501907", "301501908",
    "301501909", "301501914", "301501936", "301501989", "301801046", "301801292", "301801293", "301801296",
    "301801300", "301801458", "301801495", "301801496", "301801497", "301801498", "301801511", "301801513",
    "301801516", "301801519", "301801602", "301801604", "301801715", "301802063", "301802064", "301802065",
    "301802067", "301802068", "301802069", "301802377", "301802378", "301802457", "301802631", "301802690",
    "301802691", "301802745", "301802746", "301802747", "301802749", "301802991", "301802995", "301803042",
    "301803700", "301803701", "301803702", "302102324", "302300797", "302401658", "302401745", "302402027",
    "302402035", "302402273", "302402277", "302402372", "302402514", "302402645", "302402646", "302402647",
    "302402650", "302402652", "302402658", "302402725", "302402761", "302402844", "302501430", "302502499",
    "302502773", "302502778", "302504726", "302504798", "302504799", "302504803", "302504890", "302600066",
    "302600346", "302600368", "302600372", "302700138", "302700179", "302700180", "302700181", "302700203",
    "302700217", "302700239", "302700250", "302700314", "302700321", "302700322", "302700323", "302700327",
    "302700329", "302700330", "302700334", "302700348", "302700353", "302700356", "302700357", "302700373",
    "302700374", "302700396", "302700397", "302700398", "302700443", "302700444", "302700446", "302700452",
    "302700453", "302700455", "302700456", "302700461", "302700462", "302700464", "302700465", "302700468",
    "302700469", "302700470", "302700471", "302700472", "302700475", "302700476", "302700478", "302700487",
    "302700488", "302700494", "302700501", "302700578", "302700579", "302700581", "302700582", "302700630",
    "302700684", "302700731", "302700812", "302700813", "302700835", "302700844", "302700847", "302700859",
    "302700939", "302700943", "302700944", "302700955", "302701097", "302701111", "302701221", "302701235",
    "302701248", "302701263", "302701264", "302701375", "302701376", "302701377", "302701378", "302701382",
    "302701384", "302701418", "302701424", "302701438", "302701458", "302701459", "302701477", "302701491",
    "302701499", "302701500", "302701533", "302701562", "302701569", "302701616", "302701617", "302701618",
    "302701642", "302701667", "302701678", "302701705", "302701727", "302701730", "302701732", "302701734",
    "302701735", "302701750", "302701767", "302701772", "302701822", "302701858", "302701860", "302701861",
    "302701876", "302701877", "302701922", "302701923", "302701935", "302701952", "302701980", "302702010",
    "302702037", "302702038", "302702039", "302702107", "302702111", "302702118", "302702120", "302702122",
    "302702307", "302702475", "302702497", "302702503", "302702543", "302702544", "302702620", "302702627",
    "302702656", "302702657", "302702742", "302702763", "302702764", "302702842", "302702865", "302702877",
    "302702926", "302702959", "302703190", "302703191", "302703200", "302703201", "302703390", "302703393",
    "302703422", "302703427", "302703432", "302703593", "302902550", "302903283", "302904925", "302905660",
    "302905662", "302906230", "302915985", "302917210", "302917357", "302917358", "302917740", "302918463",
    "302918662", "302918666", "302918805", "302919168", "302919478", "302919482", "302920249", "302920251",
    "302920535", "302920537", "302920545", "302920546", "302920549", "302920730", "302920743", "302920893",
    "302920997", "302921386", "302921387", "302921388", "302921771", "302921773", "302922383", "302922547",
    "302922764", "302923094", "302923095", "303201027", "303201378", "303201578", "303201608", "303201766",
    "303202023", "303202055", "303202107", "303202131", "303501161", "303501169", "303501170", "303501173",
    "303605061", "303605886", "303609095", "303609310", "303610155", "303612501", "303612734", "303613405",
    "303613407", "303613576", "303614206", "303614222", "303614309", "303614310", "303614312", "303616119",
    "303616123", "303616134", "303616298", "303616300", "303616303", "303616304", "303616305", "303616497",
    "303616509", "303616604", "303616606", "303616638", "303616640", "303616979", "303616997", "303616998",
    "303617001", "303617005", "303617006", "303617010", "303617017", "303617019", "303617036", "303617099",
    "303617250", "303617251", "303617762", "303617856", "303617857", "303619295", "303619296", "303619574",
    "303619577", "303620575", "303620583", "303621204", "303621208", "303624049", "303624050", "303703381",
    "303800458", "303800695", "303801047", "303801158", "303801489", "303801490", "303801500", "303801508",
    "303801591", "303801602", "303801691", "303801856", "303801866", "303801867", "304900041", "304901053",
    "304901283", "305301207", "305301409", "305301599", "305301602", "305301608", "305302149", "305302400",
    "305302657", "305303026", "305303027", "305303043", "305303045", "305303100", "305303191", "305303208",
    "305303443", "305303623", "305303624", "305303711", "305303818", "305303834", "305303918", "305304016",
    "305304186", "305304318", "305304489", "305304927", "305305278", "305305466", "305305700", "305306054",
    "305400839", "305401564", "305401565", "305401566", "305401573", "305401574", "305401575", "305401680",
    "305401691", "305401819", "305401987", "305402124", "305402377", "305700452", "305700530", "305700531",
    "305700560", "305700562", "305700566", "305700586", "305700587", "305700594", "305700595", "305700600",
    "305700602", "305700727", "305700733", "305700902", "305701008", "305701020", "305701032", "305701061",
    "305701069", "305701152", "305701176", "305701232", "305701262", "305701264", "305901095", "307400306",
    "307400627", "307400635", "307500579", "307900291", "307900292", "307900371", "307900387", "307900474",
    "307900534", "307900558", "308200153", "308200166", "308200403", "308902003", "308902004", "309501604",
    "309501640", "309501650", "309501753", "309501894", "309501899", "310811701", "310811927", "310811943",
    "310811944", "310814184", "311300857", "311300858", "311300863", "311300865", "311300876", "311300878",
    "311300879", "311301472", "311302119", "311305874", "311305879", "311307362", "311308045", "311309300",
    "311311043", "311311191", "311311768", "311312385", "311312737", "311312924", "311313526", "311313527",
    "311313538", "311313539", "311313608", "311313653", "311313654", "311314087", "311314425", "311314426",
    "311314634", "311314635", "311314642", "311314661", "311314670", "311314673", "311314708", "311314709",
    "311314712", "311315185", "311315187", "311315966", "311315968", "311316045", "311316047", "311316076",
    "311316077", "311316084", "311316085", "311316092", "311316093", "311316120", "311316146", "311316203",
    "311316240", "311316463", "311316492", "311316493", "311316526", "311316661", "311316663", "311316664",
    "311316747", "311316863", "311316871", "311316876", "311316901", "311317078", "311317117", "311317149",
    "311317170", "311317236", "311317237", "311317240", "311317283", "311317301", "311317454", "311317455",
    "311317482", "311317483", "311317819", "311317843", "311318087", "311318088", "311318137", "311318139",
    "311318222", "311318234", "311318236", "311318238", "311318328", "311318330", "311318346", "311318352",
    "311318354", "311318444", "311318451", "311318466", "311318630", "311318631", "311318742", "311318787",
    "311318788", "311319243", "311319244", "311319407", "311319417", "311319439", "311319443", "311319679",
    "311319749", "311319976", "311320035", "311320038", "311320039", "311320125", "311320126", "311320141",
    "311320166", "311320167", "311320171", "311320239", "311320269", "311320378", "311320482", "311320539",
    "311320540", "311320548", "311320550", "311320564", "311320595", "311320695", "311320910", "311320911",
    "311320936", "311320942", "311320974", "311321041", "311322001", "311322015", "311322078", "311322109",
    "311322111", "311322200", "311322202", "311322232", "311322842", "311322843", "311322885", "311322897",
    "311323299", "311323354", "311323391", "311323620", "311323625", "311323664", "311323665", "311323800",
    "311323898", "311323917", "311323938", "311323960", "311323962", "311323968", "311323970", "311323972",
    "311323974", "311323976", "311323978", "311323980", "311323982", "311323994", "311323998", "311324000",
    "311324004", "311324113", "311324115", "311324116", "311324259", "311324260", "311324263", "311324264",
    "311324319", "311324320", "311324321", "311324325", "311324326", "311324331", "311324334", "311324337",
    "311324338", "311324340", "311324414", "311324496", "311324497", "311324542", "311324986", "311324987",
    "311325336", "311325338", "311325449", "311325625", "311325627", "311325863", "311325865", "311325969",
    "311325985", "311326119", "311326123", "311326141", "311326200", "311326204", "311326207", "311326277",
    "311326281", "311326284", "311326288", "311326350", "311326458", "311326672", "311326704", "311327028",
    "311327030", "311327216", "311328135", "311328188", "311328189", "311328190", "311328205", "311328206",
    "311328238", "311328240", "311328254", "311328256", "311328283", "311328419", "311328421", "311329485",
    "311329667", "311330592", "311330599", "311331524", "311332401", "311332404", "311332405", "311332448",
    "311332457", "311332459", "311501363", "311501365", "311506135", "311506136", "311900087", "311900089",
    "313201755", "313700375", "313700436", "314000657", "314200017", "314200018", "314300075", "314300162",
    "314400169", "314500145", "314611845", "314619002", "315100630", "315101515", "315101516", "315101680",
    "315101889", "315102037", "315102038", "315102155", "316400881", "317000435", "317003690", "317004274",
    "317004275", "317004982", "317004990", "317004991", "317004992", "317005242", "317005331", "317005332",
    "317005375", "317005377", "317005378", "317005379", "317005382", "317005383", "317005384", "317005394",
    "317005395", "317005396", "317005397", "317005398", "317005399", "317005476", "317005505", "317005506",
    "317005509", "317005510", "317005610", "317005647", "317005649", "317005650", "317005652", "317006734",
    "317006736", "317006737", "317006946", "317006947", "317100150", "317200145", "317200375", "317200389",
    "317200474", "317200477", "317200483", "317200486", "317500039", "317500051", "317500068", "317500223",
    "317500225", "317500473", "317500482", "317500531", "317500532", "317500578", "317500669", "317600127",
    "317600133", "317600163", "317600215", "317600305", "317600978", "317601460", "317700042", "320500025",
    "320500032", "321000097", "321000099", "321000248", "321000249", "321000250", "321000273", "321000274",
    "321000275", "321000591", "321000592", "321000593", "321000594", "321000596", "321200047", "321200048",
    "321200171", "321200174", "321200195", "321200196", "321200260", "321200262", "321200268", "321200285",
    "321200286", "322100365", "327000159", "327000220", "327000243", "327000245", "327000311", "327000323",
    "327000324", "327000383", "327000399", "327000406", "327000458", "327000460", "327000466", "327000607",
    "327000671", "327000847", "327000856", "327000906", "327001023", "327001105", "327001129", "327001138",
    "327001208", "327001367", "327001436", "327001597", "327001635", "327001751", "327002447", "327400056",
    "327400066", "327400110", "327400192", "327700001", "327700022", "327800611", "327800615", "327800921",
    "327801487", "327801488", "327801522", "327801526", "336800062", "336800063", "336800064", "336800065",
    "336800076", "336800077", "336800078", "336800110", "336800111", "338000147", "347000001", "347000006",
    "347000011", "347000022", "347000024", "347000026", "347000033", "347000061", "347000093", "347000094",
    "347000095", "347000096", "347000097", "347000098", "347000099", "347000100", "347000132", "347000138",
    "361301852", "M00000920", "M00050223", "M00071718", "M00071722", "M00071766", "M00077543", "M00077545",
    "M00077583", "M00077823", "M00078079", "M00078083", "M00078274", "M00080171", "M00080176", "M00080179",
    "M00080181", "M00089596", "M00102095", "M00127284", "M00164347", "M00173839", "M00175911", "M00176474",
    "M00179117", "M00179118", "M00180262", "M00180263", "M00183672", "M00190995", "M00197055"
}

def find_item_coordinates(pdf):
    coords = []
    for i, page in enumerate(pdf):
        for block in page.get_text("dict")["blocks"]:
            for line in block.get("lines", []):
                for span in line.get("spans", []):
                    t = span["text"].strip()
                    if t in KNOWN_ITEMS and span["bbox"][0] < 200:
                        coords.append((i, t, span["bbox"][0], span["bbox"][1]))
    return coords

def overlay_barcodes(pdf, items):
    for page_index, item, x, y in items:
        page = pdf[page_index]
        barcode_width_pt = 300
        barcode_height_pt = 80
        right_edge = 612
        margin = 30
        left = right_edge - barcode_width_pt - margin
        right = right_edge - margin
        top = y - 25
        bottom = top + barcode_height_pt

        if left < 0:
            left = 0
            right = barcode_width_pt

        bg_margin = 15
        bg_rect = fitz.Rect(left - bg_margin, top - bg_margin, right + bg_margin, bottom + bg_margin)
        page.draw_rect(bg_rect, color=(1, 1, 1), fill=(1, 1, 1))

        buf = BytesIO()
        tmp_canvas = canvas.Canvas(buf, pagesize=(barcode_width_pt, barcode_height_pt))

        # ðŸ”‘ CHANGED: humanReadable=False â†’ no number under barcode
        barcode = code128.Code128(
            item,
            barHeight=barcode_height_pt - 30,
            barWidth=1.5,
            humanReadable=False  # â† this removes the number
        )
        barcode_width_actual = barcode.width
        x_offset = (barcode_width_pt - barcode_width_actual) / 2
        barcode.drawOn(tmp_canvas, x_offset, 15)
        tmp_canvas.save()

        buf.seek(0)
        img_pdf = fitz.open("pdf", buf.read())
        target_rect = fitz.Rect(left, top, right, bottom)
        page.show_pdf_page(target_rect, img_pdf, 0)

    return pdf

# ðŸ”‘ NEW: Generate clean barcode-only sheet
def generate_barcode_only_sheet(items):
    buffer = BytesIO()
    c = canvas.Canvas(buffer, pagesize=letter)
    width, height = letter
    margin = 80
    y = height - 120

    for idx, (_, item, _, _) in enumerate(items):
        if y < 150:
            c.showPage()
            y = height - 120

        # Only barcode, no text, same style
        barcode = code128.Code128(
            item,
            barHeight=50,
            barWidth=1.5,
            humanReadable=False
        )
        barcode.drawOn(c, margin, y - 60)
        y -= 120  # space between barcodes

    c.save()
    buffer.seek(0)
    return buffer.getvalue()

# --- Streamlit UI ---
st.set_page_config(page_title="Picking Ticket Barcode Generator", layout="centered")
st.title("ðŸ“¦ Picking Ticket Barcode Generator")
st.write(
    """
    Upload a **Picking Ticket PDF** (18 Wheels format).  
    This tool detects item numbers and adds **wide, high-quality, readable Code 128 barcodes** 
    on the right side â€” styled like the original top-right barcode for optimal scanning.
    """
)

uploaded_file = st.file_uploader("Upload Picking Ticket PDF", type=["pdf"])

if uploaded_file:
    pdf = fitz.open(stream=uploaded_file.read(), filetype="pdf")
    with st.spinner("ðŸ” Analyzing picking ticket..."):
        items = find_item_coordinates(pdf)

    if not items:
        st.error("âŒ No valid item numbers found.")
    else:
        st.success(f"âœ… Found {len(items)} item number(s).")
        if st.checkbox("Show detected item numbers"):
            st.write([i[1] for i in items])

        col1, col2 = st.columns(2)

        with col1:
            if st.button("ðŸ–¨ï¸ Annotated Picking Ticket"):
                with st.spinner("Generating..."):
                    out_pdf = overlay_barcodes(pdf, items)
                    output = BytesIO()
                    out_pdf.save(output)
                    st.download_button(
                        "ðŸ“¥ Download Annotated PDF",
                        output.getvalue(),
                        "picking_ticket_with_barcodes.pdf",
                        "application/pdf"
                    )

        with col2:
            if st.button("ðŸ“„ Barcodes Only (For Warehouse)"):
                with st.spinner("Generating clean sheet..."):
                    clean_pdf = generate_barcode_only_sheet(items)
                    st.download_button(
                        "ðŸ“¥ Download Barcodes Only",
                        clean_pdf,
                        "warehouse_barcodes.pdf",
                        "application/pdf"
                    )

    pdf.close()
